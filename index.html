<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JSON to CSV Converter • Free, Private, Instant • tocsv.org</title>
    <meta name="description" content="Convert JSON to CSV instantly in your browser. Zero server upload, no files stored, no tracking. Free and unlimited.">
    
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tocsv.org/">
    <meta property="og:title" content="JSON to CSV Converter • Free, Private, Instant">
    <meta property="og:description" content="100% Client-Side. Convert large JSON datasets to CSV instantly.">
    <meta property="og:image" content="https://tocsv.org/og-image.png">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Favicon (Inline SVG for instant visual) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡️</text></svg>">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg: #F5F5F7; /* Apple-like light gray */
            --surface: #FFFFFF;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --accent: #0071E3; /* Apple Blue */
            --success: #34C759;
            --error: #FF3B30;
            --border: #D2D2D7;
            --shadow: 0 4px 24px rgba(0,0,0,0.04);
            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* App-like feel */
        }

        /* --- Header --- */
        header {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            flex-shrink: 0;
        }

        .brand { display: flex; flex-direction: column; }
        h1 { font-size: 1.1rem; font-weight: 600; margin: 0; letter-spacing: -0.02em; }
        .tagline { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; font-weight: 400; }

        .controls { display: flex; gap: 12px; align-items: center; }
        
        button {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 16px;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-main);
        }

        button:hover { background: #FAFAFA; border-color: #B0B0B5; transform: translateY(-1px); }
        button:active { transform: translateY(0); background: #F0F0F0; }
        
        .btn-primary { background: var(--text-main); color: white; border: none; }
        .btn-primary:hover { background: #000; border: none; }

        /* --- Main Layout --- */
        main {
            flex: 1;
            display: flex;
            padding: 16px;
            gap: 16px;
            overflow: hidden;
            position: relative;
        }

        .pane {
            flex: 1;
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
            transition: border-color 0.3s;
        }

        .pane.active-drag { border-color: var(--accent); background: #F0F8FF; }
        .pane.error { border-color: var(--error); }
        .pane.success { border-color: var(--success); }

        .pane-header {
            padding: 12px 20px;
            border-bottom: 1px solid #F0F0F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #FFFFFF;
        }

        .pane-title { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
        .pane-stats { font-size: 0.75rem; font-family: var(--font-code); color: var(--text-sub); background: #F5F5F7; padding: 4px 8px; border-radius: 4px; }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        textarea {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            padding: 20px;
            font-family: var(--font-code);
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-main);
            outline: none;
            background: transparent;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        textarea::placeholder { color: #D1D1D6; }

        /* --- Overlay Actions --- */
        .pane-actions {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            opacity: 0; 
            transition: opacity 0.2s;
            pointer-events: none; /* Allow click through when hidden */
        }

        .pane:hover .pane-actions, textarea:focus + .pane-actions { opacity: 1; pointer-events: auto; }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }

        /* --- Footer --- */
        footer {
            padding: 8px 16px;
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-sub);
            background: var(--bg);
            border-top: 1px solid var(--border);
        }
        footer strong { color: var(--success); }

        /* --- Status Bar (Toast) --- */
        #status-bar {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #status-bar.show { transform: translateX(-50%) translateY(0); }
        #status-bar.error-toast { background: var(--error); }

        /* --- Mobile Adaptation --- */
        @media (max-width: 768px) {
            main { flex-direction: column; overflow-y: auto; height: auto; }
            .pane { min-height: 40vh; flex: none; }
            body { height: auto; min-height: 100vh; overflow-y: auto; }
            h1 { font-size: 1rem; }
            .tagline { display: none; }
            .pane-actions { opacity: 1; pointer-events: auto; } /* Always show actions on mobile */
        }

        /* Utility */
        .hidden { display: none; }
        .drag-overlay {
            position: absolute;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0, 113, 227, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--accent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            backdrop-filter: blur(2px);
        }
        .pane.active-drag .drag-overlay { opacity: 1; }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <h1>JSON to CSV Converter</h1>
            <span class="tagline">100% Client-Side • Secure • Instant</span>
        </div>
        <button id="swap-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
            Swap Direction
        </button>
    </header>

    <main>
        <!-- LEFT PANE (Source) -->
        <div class="pane" id="pane-left">
            <div class="pane-header">
                <span class="pane-title" id="title-left">JSON</span>
                <span class="pane-stats" id="stats-left">0 items</span>
            </div>
            <div class="editor-container">
                <textarea id="input-area" spellcheck="false" placeholder="Paste JSON here or drag & drop a file..."></textarea>
                <div class="drag-overlay">Drop File Here</div>
            </div>
            <div class="pane-actions">
                <button class="action-btn" id="clear-btn" title="Clear">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            </div>
        </div>

        <!-- RIGHT PANE (Result) -->
        <div class="pane" id="pane-right">
            <div class="pane-header">
                <span class="pane-title" id="title-right">CSV</span>
                <span class="pane-stats" id="stats-right">0 rows</span>
            </div>
            <div class="editor-container">
                <textarea id="output-area" readonly spellcheck="false" placeholder="Result will appear here..."></textarea>
            </div>
            <div class="pane-actions">
                <button class="action-btn" id="copy-btn" title="Copy to Clipboard">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                </button>
                <button class="action-btn" id="download-btn" title="Download File">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div id="status-bar">Ready</div>
        <strong>100% Client-Side</strong> • Your data never leaves your browser • No tracking • No limits • tocsv.org
    </footer>

    <script>
        // --- State & DOM ---
        let mode = 'json2csv'; // or 'csv2json'
        const inputArea = document.getElementById('input-area');
        const outputArea = document.getElementById('output-area');
        const leftTitle = document.getElementById('title-left');
        const rightTitle = document.getElementById('title-right');
        const leftStats = document.getElementById('stats-left');
        const rightStats = document.getElementById('stats-right');
        const swapBtn = document.getElementById('swap-btn');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const statusBar = document.getElementById('status-bar');
        const leftPane = document.getElementById('pane-left');

        // --- Utilities ---
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const showToast = (msg, isError = false) => {
            statusBar.textContent = msg;
            statusBar.classList.add('show');
            if(isError) statusBar.classList.add('error-toast');
            else statusBar.classList.remove('error-toast');
            
            setTimeout(() => statusBar.classList.remove('show'), 3000);
        };

        const formatNumber = (num) => new Intl.NumberFormat().format(num);

        // --- Core Conversion Logic ---
        const processConversion = () => {
            const raw = inputArea.value.trim();
            
            if (!raw) {
                outputArea.value = '';
                leftStats.textContent = '0 items';
                rightStats.textContent = '0 rows';
                leftPane.classList.remove('error', 'success');
                return;
            }

            if (mode === 'json2csv') {
                try {
                    // 1. Validate & Parse JSON
                    let jsonData;
                    try {
                        jsonData = JSON.parse(raw);
                    } catch (e) {
                        throw new Error("Invalid JSON format");
                    }

                    // Normalize to array
                    if (!Array.isArray(jsonData)) jsonData = [jsonData];

                    leftStats.textContent = `${formatNumber(jsonData.length)} objects`;
                    if (jsonData.length > 50000) showToast(`Large dataset (${formatNumber(jsonData.length)} rows). Rendering might take a moment.`);

                    // 2. Convert to CSV using PapaParse
                    const csv = Papa.unparse(jsonData, { quotes: true }); // Quotes true is safer
                    outputArea.value = csv;
                    
                    // Stats
                    const lines = csv.split(/\r\n|\r|\n/).length;
                    rightStats.textContent = `${formatNumber(lines)} lines`;
                    
                    leftPane.classList.remove('error');
                    leftPane.classList.add('success');

                } catch (err) {
                    leftPane.classList.add('error');
                    leftPane.classList.remove('success');
                    leftStats.textContent = 'Error';
                    showToast(err.message, true);
                }
            } else {
                // CSV to JSON
                Papa.parse(raw, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            leftPane.classList.add('error');
                            showToast(`CSV Error: ${results.errors[0].message}`, true);
                        } else {
                            leftPane.classList.remove('error');
                            leftPane.classList.add('success');
                            const jsonStr = JSON.stringify(results.data, null, 2);
                            outputArea.value = jsonStr;
                            
                            leftStats.textContent = `${formatNumber(results.data.length)} rows`;
                            rightStats.textContent = `${formatNumber(jsonStr.length)} chars`;
                        }
                    }
                });
            }
        };

        // --- Event Listeners ---
        
        // 1. Debounced Input
        inputArea.addEventListener('input', debounce(processConversion, 400));

        // 2. Swap Direction
        swapBtn.addEventListener('click', () => {
            mode = mode === 'json2csv' ? 'csv2json' : 'json2csv';
            
            // Update UI Text
            leftTitle.textContent = mode === 'json2csv' ? 'JSON' : 'CSV';
            rightTitle.textContent = mode === 'json2csv' ? 'CSV' : 'JSON';
            inputArea.placeholder = mode === 'json2csv' ? 'Paste JSON here...' : 'Paste CSV here...';
            
            // Swap Content (smart swap)
            const currentOut = outputArea.value;
            const currentIn = inputArea.value;
            
            if (currentOut) {
                inputArea.value = currentOut;
                processConversion(); // Trigger conversion immediately
            } else {
                inputArea.value = '';
                outputArea.value = '';
                leftPane.classList.remove('success', 'error');
            }
        });

        // 3. Actions
        clearBtn.addEventListener('click', () => {
            inputArea.value = '';
            outputArea.value = '';
            leftStats.textContent = ''; 
            rightStats.textContent = '';
            leftPane.classList.remove('error', 'success');
            inputArea.focus();
        });

        copyBtn.addEventListener('click', () => {
            if(!outputArea.value) return;
            outputArea.select();
            document.execCommand('copy');
            showToast('Copied to clipboard!');
            window.getSelection().removeAllRanges();
        });

        downloadBtn.addEventListener('click', () => {
            if(!outputArea.value) return;
            const content = outputArea.value;
            const ext = mode === 'json2csv' ? 'csv' : 'json';
            const type = mode === 'json2csv' ? 'text/csv;charset=utf-8' : 'application/json;charset=utf-8';
            const blob = new Blob([content], { type: type });
            saveAs(blob, `tocsv-export.${ext}`);
        });

        // 4. Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            leftPane.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        leftPane.addEventListener('dragenter', () => leftPane.classList.add('active-drag'));
        leftPane.addEventListener('dragleave', () => leftPane.classList.remove('active-drag'));

        leftPane.addEventListener('drop', (e) => {
            leftPane.classList.remove('active-drag');
            const dt = e.dataTransfer;
            const files = dt.files;

            if(files.length) {
                handleFiles(files[0]);
            }
        });

        function handleFiles(file) {
            const reader = new FileReader();
            
            // Auto-detect mode based on extension
            if (file.name.endsWith('.csv')) {
                if(mode === 'json2csv') swapBtn.click(); // Switch to CSV mode if needed
            } else if (file.name.endsWith('.json')) {
                if(mode === 'csv2json') swapBtn.click(); // Switch to JSON mode
            }

            reader.onload = function(e) {
                inputArea.value = e.target.result;
                processConversion();
                showToast(`Loaded ${file.name}`);
            }
            reader.readAsText(file);
        }

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(req => {
                    console.log('Service Worker Registered');
                });
            });
        }
    </script>
</body>
</html>